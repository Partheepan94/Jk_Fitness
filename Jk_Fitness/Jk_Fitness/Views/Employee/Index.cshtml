
@{
    ViewData["Title"] = "Employee Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@*Initially Table and button loading*@
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="form-group">
                    <h3 class="card-title">Display Employee Details</h3>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Branch</label>
                            <div class="col-md-12 col-sm-12 ">
                                <select class="form-control" id="BranchforSearch"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Name</label>
                            <div class="col-md-12 col-sm-12 ">
                                <input type="text" id="NameforSearch" class="form-control" placeholder="Enter Name">
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="float:right">
                                <button type="button" id="btnSearch" class="btn btn-secondary"><i class="fa fa-search"></i> Search</button>
                                <button type="button" id="btnAdd" class="btn btn-success"><i class="fa fa-plus"></i> Add New</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer table-responsive">
                <table id="example1" class="table table-bordered table-striped tblEmployee">
                    <thead>
                        <tr>
                            <th>Employee Id</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Branch</th>
                            <th>User Type</th>
                            <th>Active</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyid">
                    </tbody>

                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
    <!-- /.col -->
</div>

@* Add new Employee and EDIT Employee Popup *@
<div id="EmpModal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Employee Details</h4>
                <button type="button" class="close" data-dismiss="modal" onclick="Cancel()">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="x_panel">
                    <div class="x_content">
                        <form id="formUser" class="form-horizontal form-label-left" enctype="multipart/form-data">
                            <input type="hidden" value="0" id="EmployeeId" />
                            <div class="form-group row ">
                                <label class="control-label col-md-3 col-sm-3 ">Salutation</label>
                                <div class="col-md-9 col-sm-9">
                                    <select class="form-control" id="Salutation"></select>
                                </div>
                            </div>
                            <div class="form-group row ">
                                <label class="control-label col-md-3 col-sm-3">First Name</label>
                                <div class="col-md-9 col-sm-9">
                                    <input type="text" required id="Fname" class="form-control">
                                    @*<span class="error" style="color: red">
                                        Empty fiels Required
                                    </span>*@
                                </div>
                            </div>
                            <div class="form-group row ">
                                <label class="control-label col-md-3 col-sm-3 ">Last Name</label>
                                <div class="col-md-9 col-sm-9">
                                    <input type="text" id="Lname" class="form-control">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="control-label col-md-3 col-sm-3 ">Address</label>
                                <div class="col-md-9 col-sm-9">
                                    <textarea id="Address" class="form-control"></textarea>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="control-label col-md-3 col-sm-3 ">Email</label>
                                <div class="col-md-9 col-sm-9 ">
                                    <input type="text" id="Email" class="form-control">
                                </div>
                            </div>
                            <div class="form-group row ">
                                <label class="control-label col-md-3 col-sm-3 ">Contact No</label>
                                <div class="col-md-9 col-sm-9 ">
                                    <input type="text" id="ContactNo" class="form-control">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="control-label col-md-3 col-sm-3 ">Branch</label>
                                <div class="col-md-9 col-sm-9 ">
                                    <select class="form-control" id="Branch"></select>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="control-label col-md-3 col-sm-3 ">User Type</label>
                                <div class="col-md-9 col-sm-9 ">
                                    <select class="form-control" id="UserType"></select>
                                </div>
                            </div>
                            <div class="bootstrap-timepicker">
                                <div class="form-group row">
                                    <label class="control-label col-md-3 col-sm-3">Morning Start Time</label>

                                    <div class="input-group date col-md-3 col-sm-3" id="timepicker" data-target-input="nearest">
                                        <input type="text" id="MorningIn" class="form-control datetimepicker-input" data-target="#timepicker" />
                                        <div class="input-group-append" data-target="#timepicker" data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="far fa-clock"></i></div>
                                        </div>
                                    </div>

                                    <label class="control-label col-md-3 col-sm-3">Morning End Time</label>

                                    <div class="input-group date col-md-3 col-sm-3" id="timepicker1" data-target-input="nearest">
                                        <input type="text" id="MorningOut" class="form-control datetimepicker-input" data-target="#timepicker1" />
                                        <div class="input-group-append" data-target="#timepicker1" data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="far fa-clock"></i></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bootstrap-timepicker">
                                <div class="form-group row">
                                    <label class="control-label col-md-3 col-sm-3">Evening Start Time</label>

                                    <div class="input-group date col-md-3 col-sm-3" id="timepicker2" data-target-input="nearest">
                                        <input type="text" id="EveningIn" class="form-control datetimepicker-input" data-target="#timepicker2" />
                                        <div class="input-group-append" data-target="#timepicker2" data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="far fa-clock"></i></div>
                                        </div>
                                    </div>

                                    <label class="control-label col-md-3 col-sm-3" @*style="text-align:center"*@>Evening End Time</label>

                                    <div class="input-group date col-md-3 col-sm-3" id="timepicker3" data-target-input="nearest">
                                        <input type="text" id="EveningOut" class="form-control datetimepicker-input" data-target="#timepicker3" />
                                        <div class="input-group-append" data-target="#timepicker3" data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="far fa-clock"></i></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="Status" value="true">
                                <label class="control-label" for="Status">Active</label>
                            </div>

                            <div class="ln_solid"></div>
                            <div class="form-group">
                                <div style="float:right">
                                    <button type="button" id="btnAddEmployee" class="btn btn-success">Save</button>
                                    <button type="button" onclick="Cancel()" class="btn btn-warning">Cancel</button>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        ListEmployeeDetails();
        LoadBranchesforSearch();

    });

    @*for Time Picker *@
    $(function () {
        //Date picker
        $('#timepicker').datetimepicker({
            format: 'LT'
        })
        $('#timepicker1').datetimepicker({
            format: 'LT'
        })
        $('#timepicker2').datetimepicker({
            format: 'LT'
        })
        $('#timepicker3').datetimepicker({
            format: 'LT'
        })
    });

    $('#btnAdd').click(function () {
        $('#EmpModal').modal('show');
        LoadBranches();
        LoadUserTypes();
        LoadSalutation();
    });

    function ListEmployeeDetails() {
        $.ajax({
            type: 'GET',
            url: '@Url.Action("GetEmployeeDetails", "Employee")',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    var EmpList = myData.data;
                    var tr = [];
                    for (var i = 0; i < EmpList.length; i++) {
                        tr.push('<tr>');
                        tr.push("<td>" + EmpList[i].employeeId + "</td>");
                        tr.push("<td>" + EmpList[i].firstName + "</td>");;
                        tr.push("<td>" + EmpList[i].lastName + "</td>");;
                        tr.push("<td>" + EmpList[i].branch + "</td>");;
                        tr.push("<td>" + EmpList[i].userType + "</td>");;
                        tr.push("<td>" + EmpList[i].active + "</td>");;
                        tr.push("<td><button onclick=\"EditEmployee('" + EmpList[i].employeeId + "')\" class=\"btn btn-primary\"><i class=\"fa fa-edit\"></i> Edit </button></td>");
                        tr.push("<td><button onclick=\"DeleteEmployee('" + EmpList[i].employeeId + "')\" class=\"btn btn-danger\"><i class=\"fa fa-trash\"></i> Delete </button></td>")
                        tr.push('</tr>');
                    }

                    $("#tbodyid").empty();
                    $('.tblEmployee').append($(tr.join('')));
                } else if (myData.code == "0") {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'No data Found!',
                    });

                    var tr = [];
                    $("#tbodyid").empty();
                    $('.tblEmployee').append($(tr.join('')));
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }
            },
            error: function (jqXHR, exception) {
            }
        });
    }

    function LoadBranches() {
        $('#Branch').find('option').remove().end();
        Branch = $('#Branch');

        $.ajax({
            type: 'GET',
            url: '@Url.Action("GetBranchDetails", "Employee")',
            dataType: 'json',
            headers: {
                "Authorization": "Bearer " + sessionStorage.getItem('token'),
            },
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    var Result = myData.data;
                    Branch.append($("<option/>").val(0).text("-Select Branch-"));
                    $.each(Result, function () {
                        Branch.append($("<option/>").val(this.branchName).text(this.branchName));
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }
            },
            error: function (jqXHR, exception) {
            }
        });
    }

    function LoadUserTypes() {
        $('#UserType').find('option').remove().end();
        UserType = $('#UserType');

        $.ajax({
            type: 'GET',
            url: '@Url.Action("GetUserTypeDetails", "Employee")',
            dataType: 'json',
            headers: {
                "Authorization": "Bearer " + sessionStorage.getItem('token'),
            },
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    var Result = myData.data;
                    UserType.append($("<option/>").val(0).text("-Select UserType-"));
                    $.each(Result, function () {
                        UserType.append($("<option/>").val(this.role).text(this.role));
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }
            },
            error: function (jqXHR, exception) {
            }
        });
    }

    function LoadSalutation() {
        $('#Salutation').find('option').remove().end();
        Salutation = $('#Salutation');
        var SalutationList = [
            { Id: 1, Name: "Mr" },
            { Id: 2, Name: "Mrs" },
            { Id: 3, Name: "Ms" },
            { Id: 4, Name: "Miss" },
            { Id: 5, Name: "Dr" },
            { Id: 5, Name: "Professor" }
        ];
        Salutation.append($("<option/>").val(0).text("-Select Salutation-"))
        $.each(SalutationList, function () {
            Salutation.append($("<option/>").val(this.Name).text(this.Name));
        });
    }


    $('#btnAddEmployee').click(function () {

        var EmployeeId = $('#EmployeeId').val();
        var Salutation = $('#Salutation').val();
        var Fname = $('#Fname').val();
        var Lname = $('#Lname').val();
        var Address = $('#Address').val();
        var Email = $('#Email').val();
        var ContactNo = $('#ContactNo').val();
        var Branch = $('#Branch').val();
        var UserType = $('#UserType').val();
        var MorningIn = $('#MorningIn').val();
        var MorningOut = $('#MorningOut').val();
        var EveningIn = $('#EveningIn').val();
        var EveningOut = $('#EveningOut').val();
        var Active = $('#Status').prop('checked') ? "true" : "false";
        var filter = /^[0][0-9]{9}$/;



        var data = '{"EmployeeId": "' + EmployeeId +
            ' ","Salutation": "' + Salutation +
            ' " ,"FirstName":" ' + Fname +
            ' " ,"LastName":" ' + Lname +
            ' ","Address":" ' + Address +
            ' " ,"Email":" ' + Email +
            ' ","PhoneNo":" ' + ContactNo +
            ' ","Branch": " ' + Branch +
            ' ","UserType":" ' + UserType +
            ' ","Active": ' + Active +
            ',"MorningInTime": "' + MorningIn +
            ' ","MorningOutTime": "' + MorningOut +
            ' ","EveningInTime": "' + EveningIn +
            ' ","EveningOutTime": "' + EveningOut + '"}';

        if (!$('#Fname').val() || !$('#Lname').val() || !$('#Address').val() || !$('#MorningIn').val() || !$('#MorningOut').val() || !$('#EveningIn').val() || !$('#EveningOut').val()) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Empty Value Can not be Allow!',
            });
        }
        else if (!filter.test(ContactNo)) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Invalid Mobile No!',
            });
        } else if (Salutation == 0 || Branch == 0 || UserType == 0) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please Select a Value!',
            });
        } else {

            if (EmployeeId == "0" || EmployeeId=="") {

            $.ajax({
                type: 'POST',
                url: '@Url.Action("SaveEmployees", "Employee")',
                dataType: 'json',
                data: data,
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    var myData = jQuery.parseJSON(JSON.stringify(response));
                    if (myData.code == "1") {
                        Swal.fire({
                            position: 'center',
                            icon: 'success',
                            title: 'Your work has been saved',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        $('#EmpModal').modal('toggle');
                        ListEmployeeDetails();
                        Clear();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong!',
                        });
                        Clear();
                    }
                },
                error: function (jqXHR, exception) {
                }
            });

        }
        else {

            $.ajax({
            type: 'POST',
            url: '@Url.Action("UpdateEmployees", "Employee")',
            dataType: 'json',
            data: data,
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Your work has been Updated',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    $('#EmpModal').modal('toggle');
                    ListEmployeeDetails();
                    Clear();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                    ListEmployeeDetails();
                    Clear();
                }
            },
            error: function (jqXHR, exception) {
            }
            });

        }

        }

    });

    function EditEmployee(Id) {
        $('#EmpModal').modal('show');
        LoadBranches();
        LoadUserTypes();
        LoadSalutation();

        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetEmployeeById", "Employee")',
            dataType: 'json',
            data: '{"EmployeeId": "' + Id + '"}',
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    var Result = myData.data;
                    $("#Salutation").val(Result['salutation']);
                    $("#Fname").val(Result['firstName']);
                    $("#Lname").val(Result['lastName']);
                    $("#Address").val(Result['address']);
                    $("#Email").val(Result['email']);
                    $("#ContactNo").val(Result['phoneNo']);
                    $("#Branch").val(Result['branch']);
                    $("#UserType").val(Result['userType']);
                    $("#MorningIn").val(Result['morningInTime']);
                    $("#MorningOut").val(Result['morningOutTime']);
                    $("#EveningIn").val(Result['eveningInTime']);
                    $("#EveningOut").val(Result['eveningOutTime']);
                    $("#Status").prop("checked", Result.active)
                    $("#EmployeeId").val(Result['employeeId']);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }

            },
            error: function (jqXHR, exception) {

            }
        });

    }

    function DeleteEmployee(Id) {

        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.value) {

            $.ajax({
                type: 'POST',
                url: '@Url.Action("DeleteEmployees", "Employee")',
                dataType: 'json',
                data: '{"EmployeeId": "' + Id + '"}',
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    var myData = jQuery.parseJSON(JSON.stringify(response));
                    if (myData.code == "1") {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Your record has been deleted.',
                            icon: 'success',
                        });
                        ListEmployeeDetails();
                    } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                    }

                 },
                error: function (jqXHR, exception) {

                }
            });

            }
        })
    }

    function LoadBranchesforSearch() {
        $('#BranchforSearch').find('option').remove().end();
        BranchforSearch = $('#BranchforSearch');

        $.ajax({
            type: 'GET',
            url: '@Url.Action("GetBranchDetails", "Employee")',
            dataType: 'json',
            headers: {
                "Authorization": "Bearer " + sessionStorage.getItem('token'),
            },
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    var Result = myData.data;
                    BranchforSearch.append($("<option/>").val(0).text("-Select Branch-"));
                    $.each(Result, function () {
                        BranchforSearch.append($("<option/>").val(this.branchName).text(this.branchName));
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }
            },
            error: function (jqXHR, exception) {
            }
        });
    }

    $('#btnSearch').click(function () {
        var Branch = $('#BranchforSearch').val();
        var FName = $('#NameforSearch').val();

        $.ajax({
            type: 'POST',
            url: '@Url.Action("SearchEmployees", "Employee")',
            dataType: 'json',
            data: '{"FirstName": "' + FName + '","Branch": "' + Branch + '"}',
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var myData = jQuery.parseJSON(JSON.stringify(response));
                if (myData.code == "1") {
                    var EmpList = myData.data;
                    var tr = [];
                    for (var i = 0; i < EmpList.length; i++) {
                        tr.push('<tr>');
                        tr.push("<td>" + EmpList[i].employeeId + "</td>");
                        tr.push("<td>" + EmpList[i].firstName + "</td>");;
                        tr.push("<td>" + EmpList[i].lastName + "</td>");;
                        tr.push("<td>" + EmpList[i].branch + "</td>");;
                        tr.push("<td>" + EmpList[i].userType + "</td>");;
                        tr.push("<td>" + EmpList[i].active + "</td>");;
                        tr.push("<td><button onclick=\"EditEmployee('" + EmpList[i].employeeId + "')\" class=\"btn btn-primary\"><i class=\"fa fa-edit\"></i> Edit </button></td>");
                        tr.push("<td><button onclick=\"DeleteEmployee('" + EmpList[i].employeeId + "')\" class=\"btn btn-danger\"><i class=\"fa fa-trash\"></i> Delete </button></td>")
                        tr.push('</tr>');
                    }

                    $("#tbodyid").empty();
                    $('.tblEmployee').append($(tr.join('')));
                } else if (myData.code == "0") {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'No data Found!',
                    });

                    var tr = [];
                    $("#tbodyid").empty();
                    $('.tblEmployee').append($(tr.join('')));
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }

            },
            error: function (jqXHR, exception) {

            }
        });
    });

    function Clear() {
        $('#EmployeeId').val('');
        $('#Salutation').val('');
        $('#Fname').val('');
        $('#Lname').val('');
        $('#Address').val('');
        $('#Email').val('');
        $('#ContactNo').val('');
        $('#Branch').val('');
        $('#UserType').val('');
        $('#MorningIn').val('');
        $('#MorningOut').val('');
        $('#EveningIn').val('');
        $('#EveningOut').val('');
        $('#Status').prop('checked', true);
    }

    function Cancel() {
        $('#EmpModal').modal('toggle');
        ListEmployeeDetails();
        Clear();
    }


</script>
